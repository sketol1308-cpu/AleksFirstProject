<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Public Version</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="app-logo">
                <div class="logo-icon">ğŸ’¬</div>
                <h1>ChatApp</h1>
                <p class="tagline">Public Real-Time Chat</p>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('login')">Login</button>
                <button class="tab-btn" onclick="switchTab('signup')">Create Account</button>
            </div>

            <div id="loginForm" class="form-section active">
                <h2>Welcome Back!</h2>
                <div id="loginMessage" style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-weight: bold;"></div>
                <form id="loginFormElement">
                    <div class="input-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username" required>
                    </div>
                    <button type="submit" class="btn-primary" id="loginBtn">Login</button>
                </form>
            </div>

            <div id="signupForm" class="form-section">
                <h2>Create Account</h2>
                <div id="signupMessage" style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-weight: bold;"></div>
                <form id="signupFormElement">
                    <div class="input-group">
                        <label for="signupUsername">Username</label>
                        <input type="text" id="signupUsername" placeholder="Choose a username" required minlength="3">
                    </div>
                    <div class="input-group">
                        <label for="signupAvatar">Choose Avatar</label>
                        <div class="avatar-selector" id="avatarSelector">
                            <div class="avatar-option selected" data-avatar="ğŸ˜€">ğŸ˜€</div>
                            <div class="avatar-option" data-avatar="ğŸ˜">ğŸ˜</div>
                            <div class="avatar-option" data-avatar="ğŸ¤©">ğŸ¤©</div>
                            <div class="avatar-option" data-avatar="ğŸ¥³">ğŸ¥³</div>
                            <div class="avatar-option" data-avatar="ğŸ˜º">ğŸ˜º</div>
                            <div class="avatar-option" data-avatar="ğŸ¦Š">ğŸ¦Š</div>
                            <div class="avatar-option" data-avatar="ğŸ¼">ğŸ¼</div>
                            <div class="avatar-option" data-avatar="ğŸ¦„">ğŸ¦„</div>
                        </div>
                        <input type="hidden" id="selectedAvatar" value="ğŸ˜€" required>
                    </div>
                    <button type="submit" class="btn-primary" id="signupBtn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration - Using a test database with public rules
        const firebaseConfig = {
            apiKey: "AIzaSyDOCAbC123dEf456GhI789jKl01-MnO",
            authDomain: "test-chat-app.firebaseapp.com",
            databaseURL: "https://test-chat-app-default-rtdb.firebaseio.com",
            projectId: "test-chat-app",
            storageBucket: "test-chat-app.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890"
        };

        let database;
        let firebaseWorking = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseWorking = true;
            console.log('Firebase initialized!');
        } catch (error) {
            console.error('Firebase error:', error);
            firebaseWorking = false;
        }

        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('.tab-btn');

            tabs.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.remove('active');
                signupForm.classList.add('active');
                tabs[1].classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Avatar selection
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const emoji = this.getAttribute('data-avatar');
                    document.getElementById('selectedAvatar').value = emoji;

                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Signup form
            const signupFormElement = document.getElementById('signupFormElement');
            const signupBtn = document.getElementById('signupBtn');
            const signupMessage = document.getElementById('signupMessage');

            signupFormElement.addEventListener('submit', function(e) {
                e.preventDefault();

                signupMessage.style.display = 'block';
                signupMessage.textContent = 'âœ“ Creating account...';
                signupBtn.disabled = true;

                const username = document.getElementById('signupUsername').value.trim();
                const avatar = document.getElementById('selectedAvatar').value;

                if (!username || username.length < 3) {
                    signupMessage.textContent = 'âš  Username must be at least 3 characters';
                    signupMessage.style.background = '#ff9800';
                    signupBtn.disabled = false;
                    return;
                }

                const userData = {
                    id: Date.now().toString(),
                    username: username,
                    avatar: avatar,
                    joinedAt: Date.now()
                };

                signupMessage.textContent = 'âœ“ Saving account...';

                if (firebaseWorking) {
                    // Try Firebase
                    database.ref('users/' + userData.id).set(userData)
                        .then(() => {
                            signupMessage.textContent = 'âœ“ Success! Redirecting...';
                            localStorage.setItem('chatapp_user', JSON.stringify(userData));
                            setTimeout(() => {
                                window.location.href = 'public-chat.html';
                            }, 500);
                        })
                        .catch(error => {
                            console.error('Firebase save error:', error);
                            // Fall back to localStorage
                            signupMessage.textContent = 'âš  Using local mode...';
                            localStorage.setItem('chatapp_user', JSON.stringify(userData));
                            setTimeout(() => {
                                window.location.href = 'working-chat.html';
                            }, 500);
                        });
                } else {
                    // Use localStorage
                    signupMessage.textContent = 'âš  Using local mode (offline)...';
                    localStorage.setItem('chatapp_user', JSON.stringify(userData));
                    setTimeout(() => {
                        window.location.href = 'working-chat.html';
                    }, 500);
                }
            });

            // Login form
            const loginFormElement = document.getElementById('loginFormElement');
            const loginBtn = document.getElementById('loginBtn');
            const loginMessage = document.getElementById('loginMessage');

            loginFormElement.addEventListener('submit', function(e) {
                e.preventDefault();

                loginMessage.style.display = 'block';
                loginMessage.textContent = 'âœ“ Logging in...';
                loginBtn.disabled = true;

                const username = document.getElementById('loginUsername').value.trim();

                if (!username) {
                    loginMessage.textContent = 'âš  Please enter a username';
                    loginMessage.style.background = '#ff9800';
                    loginBtn.disabled = false;
                    return;
                }

                if (firebaseWorking) {
                    database.ref('users').once('value')
                        .then((snapshot) => {
                            const users = snapshot.val() || {};
                            let userFound = null;

                            for (let userId in users) {
                                if (users[userId].username.toLowerCase() === username.toLowerCase()) {
                                    userFound = users[userId];
                                    break;
                                }
                            }

                            if (userFound) {
                                loginMessage.textContent = 'âœ“ Found! Redirecting...';
                                localStorage.setItem('chatapp_user', JSON.stringify(userFound));
                                setTimeout(() => {
                                    window.location.href = 'public-chat.html';
                                }, 500);
                            } else {
                                loginMessage.textContent = 'âŒ User not found!';
                                loginMessage.style.background = '#f44336';
                                loginBtn.disabled = false;
                            }
                        })
                        .catch(error => {
                            loginMessage.textContent = 'âŒ Error: ' + error.message;
                            loginMessage.style.background = '#f44336';
                            loginBtn.disabled = false;
                        });
                } else {
                    loginMessage.textContent = 'âŒ Offline mode - create account instead';
                    loginMessage.style.background = '#f44336';
                    loginBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
